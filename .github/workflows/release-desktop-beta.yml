name: Release Desktop Beta

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
  push:
    branches:
      - smoothing
      - gemini-thinking

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªç›¸åŒçš„ workflowï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ—§çš„è¿è¡Œ
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

# Add default permissions
permissions: read-all

jobs:
  test:
    name: Code quality check
    # æ·»åŠ  PR label è§¦å‘æ¡ä»¶ï¼Œåªæœ‰æ·»åŠ äº† Build Desktop æ ‡ç­¾çš„ PR æ‰ä¼šè§¦å‘æ„å»º
    runs-on: ubuntu-latest # åªåœ¨ ubuntu ä¸Šè¿è¡Œä¸€æ¬¡æ£€æŸ¥
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install deps
        run: pnpm install

      - name: Lint
        run: pnpm run lint

  version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Œä¾›åç»­ job ä½¿ç”¨
      version: ${{ steps.set_version.outputs.version }}
      is_pr_build: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Get short SHA
        id: slug
        run: echo "::set-output name=sha7::$(echo ${GITHUB_SHA} | cut -c1-7)"
      
      # ä¸»è¦é€»è¾‘ï¼šç¡®å®šæ„å»ºç‰ˆæœ¬å·
      - name: Set version
        id: set_version
        run: |
          version=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Workflow dispatch version
            version="${{ github.event.inputs.version }}"
            echo "ğŸ“¦ Workflow Dispatch Input Version: ${version}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Using first 7 chars of the SHA prefixed with 'dev-'
            version="0.0.0-dev-${{ steps.slug.outputs.sha7 }}"
            echo "ğŸ“¦ Push Event Auto Version: ${version}"
          else
            echo "::error::Unsupported trigger event: ${{ github.event_name }}"
            exit 1
          fi

          if [[ -z "$version" ]]; then
            echo "::error::Version could not be determined."
            exit 1
          fi

          echo "version=${version}" >> $GITHUB_OUTPUT
          # Setting is_pr_build to false
          echo "is_pr_build=false" >> $GITHUB_OUTPUT

      # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯æ€»ç»“ï¼Œæ–¹ä¾¿åœ¨ GitHub Actions ç•Œé¢æŸ¥çœ‹
      - name: Version Summary
        run: |
          echo "ğŸš¦ Release Version: ${{ steps.set_version.outputs.version }}"

  build:
    needs: [version, test]
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # æš‚æ—¶å…ˆæ”¯æŒ macOS
        os: [macos-latest]
    #        os: [macos-latest, windows-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # node-linker=hoisted æ¨¡å¼å°†å¯ä»¥ç¡®ä¿ asar å‹ç¼©å¯ç”¨
      - name: Install deps
        run: pnpm install --node-linker=hoisted

      - name: Install deps on Desktop
        run: npm run install-isolated --prefix=./apps/desktop

      # è®¾ç½® package.json çš„ç‰ˆæœ¬å·
      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.version.outputs.version }} beta

      # macOS æ„å»ºå¤„ç†
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:build
        env:
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          # é»˜è®¤æ·»åŠ ä¸€ä¸ªåŠ å¯† SECRET
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          CUSTOM_FONT_URL: ${{ secrets.CUSTOM_FONT_URL }}
          CUSTOM_FONT_FAMILY: ${{ secrets.CUSTOM_FONT_FAMILY }}

      # # é macOS å¹³å°æ„å»ºå¤„ç†
      # - name: Build artifact on other platforms
      #   if: runner.os != 'macOS'
      #   run: npm run desktop:build
      #   env:
      #     APP_URL: http://localhost:3015
      #     DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
      #     KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
      #     CUSTOM_FONT_URL: ${{ secrets.CUSTOM_FONT_URL }}
      #     CUSTOM_FONT_FAMILY: ${{ secrets.CUSTOM_FONT_FAMILY }}

      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œç§»é™¤äº† zip ç›¸å…³éƒ¨åˆ†
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            apps/desktop/release/latest*
            apps/desktop/release/*.dmg*
            apps/desktop/release/*.zip*
            apps/desktop/release/*.exe*
            apps/desktop/release/*.AppImage
          retention-days: 5
